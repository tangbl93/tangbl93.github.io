<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Docusaurus Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Docusaurus Blog Atom Feed"><title data-react-helmet="true">2、自动化打包(下) | Docusaurus</title><meta data-react-helmet="true" property="og:url" content="https://tangbl93.github.io//docs/fastlane/fastlane-gym-02"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="2、自动化打包(下) | Docusaurus"><meta data-react-helmet="true" name="description" content="上篇说了一些问题，这篇文章就来看一下怎么打包过程。这里就按照步骤来说一下。"><meta data-react-helmet="true" property="og:description" content="上篇说了一些问题，这篇文章就来看一下怎么打包过程。这里就按照步骤来说一下。"><link data-react-helmet="true" rel="shortcut icon" href="/images/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tangbl93.github.io//docs/fastlane/fastlane-gym-02"><link data-react-helmet="true" rel="alternate" href="https://tangbl93.github.io//docs/fastlane/fastlane-gym-02" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tangbl93.github.io//docs/fastlane/fastlane-gym-02" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.dc5e9681.css">
<link rel="preload" href="/assets/js/runtime~main.5abe5d4e.js" as="script">
<link rel="preload" href="/assets/js/main.c75862fc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/images/logo.svg" alt="Docusaurus Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/images/logo.svg" alt="Docusaurus Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Docusaurus</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/index">专栏</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tangbl93/tangbl93.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/images/logo.svg" alt="Docusaurus Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/images/logo.svg" alt="Docusaurus Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Docusaurus</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/index">专栏</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">博客</a></li><li class="menu__list-item"><a href="https://github.com/tangbl93/tangbl93.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/index">专栏</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Dart tour</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-preface">Dart tour: 1、概览</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-comments">Dart tour: 2、注释</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-variables">Dart tour: 3、变量</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-types">Dart tour: 4、数据类型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-functions">Dart tour: 5、函数</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-operators">Dart tour: 6、操作符</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-control">Dart tour: 7、控制流程语句</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-exceptions">Dart tour: 8、异常</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-classes">Dart tour: 9、类</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-enums">Dart tour: 10、枚举</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-mixin">Dart tour: 11、Mixin</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-generics">Dart tour: 12、泛型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-libraries">Dart tour: 13、使用库</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-asynchrony">Dart tour: 14、异步编程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-generators">Dart tour: 15、生成器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-isolates">Dart tour: 16、隔离区(Isolates)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-typedef">Dart tour: 17、Typedefs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-metadata">Dart tour: 18、Metadata</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-null-safety">Dart tour: 19、Sound null safety</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dart/dart-tour-package">Dart tour: 20、Package</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Fastlane实战</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/fastlane/index">0、前言</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/fastlane/fastlane-gym-01">1、自动化打包(上)</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/fastlane/fastlane-gym-02">2、自动化打包(下)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/fastlane/fastlane-match">3、管理证书</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/fastlane/fastlane-tjcsj">4、添加测试机</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/fastlane/fastlane-iap">5、新建内购项目</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/fastlane/fastlane-archive">6、通过Archive生成IPA</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">2、自动化打包(下)</h1></header><div class="markdown"><p>上篇说了一些问题，这篇文章就来看一下怎么打包过程。这里就按照步骤来说一下。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="需求"></a>需求<a class="hash-link" href="#需求" title="Direct link to heading">#</a></h1><p>按照我们APP现有的需求，先列举一下:</p><ol><li>打包的版本号(版本号，编译版本号)必须为偶数(便于优先追踪线上、内测版BUG)</li><li>推送到 <code>fir.im</code>，且成功后发送一条消息到钉钉</li><li>打包结束自动修改版本号、打标签并推送</li><li>由于可能会发测试版给外部用户安装，所以需要发送特定版本号给用户</li><li>需要支持打混淆分支，并将版本号同步非混淆分支</li></ol><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="非混淆分支"></a>非混淆分支<a class="hash-link" href="#非混淆分支" title="Direct link to heading">#</a></h1><p>首先，按照常规步骤先走一遍，来看看是如何做的。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">desc &quot;打测试包专用&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">lane :fir do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...接下来这个步骤的所有命令全部在这里...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-解锁远程机器钥匙串"></a>1. 解锁远程机器钥匙串<a class="hash-link" href="#1-解锁远程机器钥匙串" title="Direct link to heading">#</a></h2><p>因为我个人本身还是习惯直接通过 <code>ssh</code> 的，所以按照上一篇的加上</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># unlock_keychain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">keychain_pass = sh(&quot;cat ~/.keychain_pass_file&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;security unlock-keychain -p #{keychain_pass}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">unlock_keychain(path: &quot;~/Library/Keychains/login.keychain&quot;, password: &quot;$(cat ~/.keychain_pass_file)&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-拉取最新代码，重置本地修改"></a>2. 拉取最新代码，重置本地修改<a class="hash-link" href="#2-拉取最新代码，重置本地修改" title="Direct link to heading">#</a></h2><p>毕竟我们打包肯定要用最新代码的吧，所以这一步做了一些事，且保证不会和我们上传的有区别:</p><ul><li>获取到当前的分支名: 有几次发现某些马甲包无法自动识别分支，导致需要手动操作，其中 <code>gsub</code> 表示去除空行、换行符等</li><li>然后首先重置一次，再拉取服务器最新代码，其中 <code>--no-edit</code> 表示自动合并，否则可能拉取之后需要手动输入合并信息</li><li>最后执行 <code>pod update</code> 并再次重置,主要是有时候更新会导致工程文件变化。使用 <code>--no-repo-update</code> 纯粹是因为网络不好</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># git branch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">branch_name = sh(&quot;git rev-parse --symbolic-full-name --abbrev-ref HEAD&quot;).gsub(/\s+/, &quot;&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># git pull</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git reset --hard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git pull origin #{branch_name} --no-edit&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># pod update</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;pod update --no-repo-update&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git reset --hard&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-修改版本号"></a>3. 修改版本号<a class="hash-link" href="#3-修改版本号" title="Direct link to heading">#</a></h2><p>这里有点坑，<code>fastlane</code> 自带的那个 <code>increment_build_number</code> 有点坑，没办法使用。所以只能就手动读取、设置</p><ul><li>这里做了个兼容，也就是当版本号为x.x.0，或者当前已经为偶数时，会做不同的处理，其他时候为正常+1</li><li>#{ENV[&quot;PLISTPATH&quot;]} 表示读取环境变量中 <code>PLISTPATH</code> 的值</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># set version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">prev_apk_version = get_info_plist_value(path: &quot;#{ENV[&quot;PLISTPATH&quot;]}&quot;, key: &quot;CFBundleShortVersionString&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">prev_build_version = get_info_plist_value(path: &quot;#{ENV[&quot;PLISTPATH&quot;]}&quot;, key: &quot;CFBundleVersion&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apk_versions = prev_apk_version.split(pattern=&quot;.&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">step = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if apk_versions[2].to_i == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    step = 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">elsif (apk_versions[2].to_i % 2) == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    step = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">current_apk_version = &quot;#{apk_versions[0]}.#{apk_versions[1]}.#{apk_versions[2].to_i+step}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">current_build_version = &quot;#{prev_build_version.to_i + step}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">next_apk_version = &quot;#{apk_versions[0]}.#{apk_versions[1]}.#{apk_versions[2].to_i+step+1}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">next_build_version = &quot;#{prev_build_version.to_i + step + 1}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set_info_plist_value(path: &quot;#{ENV[&quot;PLISTPATH&quot;]}&quot;, key: &quot;CFBundleShortVersionString&quot;, value: current_apk_version)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set_info_plist_value(path: &quot;#{ENV[&quot;PLISTPATH&quot;]}&quot;, key: &quot;CFBundleVersion&quot;, value: current_build_version)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-打包内购包"></a>4. 打包内购包<a class="hash-link" href="#4-打包内购包" title="Direct link to heading">#</a></h2><p>这个步骤也就是指定了打包目录和打包类型，没什么好说的。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># output path</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">output_name = &quot;#{ENV[&quot;SCHEMA&quot;]}_v#{current_apk_version}.ipa&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">output_directory = &quot;~/Desktop/ad-hoc/#{ENV[&quot;TAGNAME&quot;]}/&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">output_path = output_directory + output_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># gym build</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">gym(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    scheme: ENV[&quot;SCHEMA&quot;], </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    workspace: &quot;ksh3.xcworkspace&quot;, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    include_bitcode: false,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    export_method:&quot;ad-hoc&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    output_name: output_name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    output_directory:output_directory)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5-上传、推送消息"></a>5. 上传、推送消息<a class="hash-link" href="#5-上传、推送消息" title="Direct link to heading">#</a></h2><ul><li>上传到 <code>fir.im</code> 并从消息中读取到 Release id，这样子可以拼接成指定版本的链接(之前我们都是手动去网站找的，累)</li><li>如果没有这个功能的话，建议更新一下。或者直接用 <code>fir publish -s #{ENV[&quot;FIRLINK&quot;]} #{output_path}</code></li><li>拼接一条消息推送到钉钉上，方便测试人员下载</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># fir cli &amp; grep Release id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">release_id = sh(&quot;fir publish -s #{ENV[&quot;FIRLINK&quot;]} #{output_path} | grep -i &#x27;Release id is &#x27; | grep -o -E &#x27;[a-z0-9]{16,}&#x27;&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># dingtalk</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">upload_msg = &quot; #{ENV[&quot;APPNAME&quot;]}v#{current_apk_version}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">upload_url = &quot;https://fir.im/#{ENV[&quot;FIRLINK&quot;]}?release_id=#{release_id}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dingtalk(access_token:dingtoken, title:upload_msg, message:upload_msg, more_url: upload_url)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="6-收尾工作"></a>6. 收尾工作<a class="hash-link" href="#6-收尾工作" title="Direct link to heading">#</a></h2><ul><li>重置一次当前的修改，保证当前环境的干净</li><li>再拉取一次服务器代码。如果在打包时有同事提交了代码，就会导致提交时报错误</li><li>打标签。这里要注意标签不能重复，否则会报错误</li><li>再次修改版本号为开发版本号，也就是单数</li><li>提交，推送，结束</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># update tags &amp; version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git reset --hard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git pull origin #{branch_name} --no-edit&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git tag #{ENV[&#x27;TAGNAME&#x27;]}_#{current_apk_version}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set_info_plist_value(path: &quot;#{ENV[&quot;PLISTPATH&quot;]}&quot;, key: &quot;CFBundleShortVersionString&quot;, value: next_apk_version)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set_info_plist_value(path: &quot;#{ENV[&quot;PLISTPATH&quot;]}&quot;, key: &quot;CFBundleVersion&quot;, value: next_build_version)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git add .&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git commit -a -m &#x27;update version&#x27;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git push origin #{branch_name} --tags&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git push origin #{branch_name}&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="混淆分支"></a>混淆分支<a class="hash-link" href="#混淆分支" title="Direct link to heading">#</a></h1><p>由于马甲包为了上架做了些混淆工作，所以会创建一个单独的 <code>分支名_appstore</code> 的分支作为混淆分支，这样会便于同步最新代码</p><p>主要步骤:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">1. 拉取非混淆分支最新代码</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2. 拼接分支名，切换到非混淆分支</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3. 合并非混淆分支代码到非混淆分支(这一步骤需要检查，可能有改动会造成冲突)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4. 通过正常打包逻辑打混淆包</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5. 打包结束后，切换到正常分支</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">6. 遴选到最后更新版本的那条记录到正常分支，然后推送到服务器</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">desc &quot;打混淆包专用&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">lane :mix do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># git branch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">branch_name = sh(&quot;git rev-parse --symbolic-full-name --abbrev-ref HEAD&quot;).gsub(/\s+/, &quot;&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 混淆后的分支名，默认为:分支名_appstore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">appstore_branch = &quot;#{branch_name}_appstore&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 拉服务器最新代码</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git reset --hard&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git pull origin #{branch_name} --no-edit&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 切换到混淆分支打包，之后切回来，遴选更新版本的变更到主分支</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git checkout #{appstore_branch}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git pull origin #{appstore_branch}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git merge #{branch_name}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fir</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git checkout #{branch_name}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git cherry-pick #{appstore_branch}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh &quot;git push origin #{branch_name}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完整代码"></a>完整代码<a class="hash-link" href="#完整代码" title="Direct link to heading">#</a></h1><p>其实上边已经把我整个打包脚本代码贴出来了，其中也没有什么敏感信息。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="环境变量文件"></a>环境变量文件<a class="hash-link" href="#环境变量文件" title="Direct link to heading">#</a></h2><blockquote><p>文件保存到和 <code>Fastfile</code> 同级，名称应为 <code>.env.xxx</code>。命令记得带上 <code>fastlane fir --env xxx</code></p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// .env.ksh3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SCHEMA=&quot;&quot;                       # schema的名字</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PLISTPATH=&quot;&quot;                    # Info.plist 的位置，路径为相对于程序根目录</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FIRLINK=&quot;&quot;                      # fir.im 的短链，如 wcfg2018</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">APPNAME=&quot;&quot;                      # APP名，中英文随意</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">TAGNAME=&quot;&quot;                      # git标签名，叫什么随意，不过最好有点意义，可以用拼音或者英文名 </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fastfile"></a>Fastfile<a class="hash-link" href="#fastfile" title="Direct link to heading">#</a></h2><p>这里我按照上篇的考虑，选择了从远程获取，这样可以始终保持最新版本</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import_from_git(url: &#x27;....git&#x27;, path: &#x27;Fastfile&#x27;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/fastlane/fastlane-gym-01"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 1、自动化打包(上)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/fastlane/fastlane-match"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">3、管理证书 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-解锁远程机器钥匙串" class="table-of-contents__link">1. 解锁远程机器钥匙串</a></li><li><a href="#2-拉取最新代码，重置本地修改" class="table-of-contents__link">2. 拉取最新代码，重置本地修改</a></li><li><a href="#3-修改版本号" class="table-of-contents__link">3. 修改版本号</a></li><li><a href="#4-打包内购包" class="table-of-contents__link">4. 打包内购包</a></li><li><a href="#5-上传、推送消息" class="table-of-contents__link">5. 上传、推送消息</a></li><li><a href="#6-收尾工作" class="table-of-contents__link">6. 收尾工作</a></li><li><a href="#环境变量文件" class="table-of-contents__link">环境变量文件</a></li><li><a href="#fastfile" class="table-of-contents__link">Fastfile</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5abe5d4e.js"></script>
<script src="/assets/js/main.c75862fc.js"></script>
</body>
</html>